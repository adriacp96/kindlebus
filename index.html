<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindle Bus</title>
    <style>
        :root {
            --bg: #ffffff; 
            --text: #000000; 
            --gray-bg: #eeeeee;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: "Amazon Ember", "Helvetica", "Arial", sans-serif;
            margin: 0;
            padding: 20px;
            width: 100vw;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 8px solid #000;
            padding-bottom: 15px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .route-info h1 {
            font-size: 18px;
            font-weight: 800;
            margin: 0;
            letter-spacing: 2px;
        }

        .route-number {
            font-size: 64px;
            font-weight: 900;
            margin: -10px 0 0 0;
            line-height: 1;
        }

        .bus-img {
            height: 75px;
            filter: grayscale(1) contrast(5);
            cursor: pointer;
            /* No transitions for Kindle E-ink */
        }

        .bus-flipped {
            transform: scaleX(-1);
        }

        .clock-section {
            text-align: right;
        }

        #live-clock {
            font-size: 38px;
            font-weight: 900;
            margin: 0;
            font-variant-numeric: tabular-nums;
        }

        /* BUS TABLE */
        .board-headers {
            display: flex;
            padding: 12px;
            background: #000;
            color: #fff;
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
            text-align: center;
            flex-shrink: 0;
        }

        #schedule-container {
            flex-shrink: 0;
        }

        .row {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 3px solid #000;
            text-align: center;
        }

        .row.next {
            background-color: var(--gray-bg);
            border-bottom: 10px solid #000;
            padding: 20px 10px;
        }

        .col-time   { width: 18%; font-size: 32px; font-weight: 800; }
        .col-from   { width: 22%; font-size: 16px; font-weight: 700; color: #333; }
        .col-to     { width: 20%; font-size: 18px; font-weight: 800; }
        .col-due     { width: 25%; font-size: 36px; font-weight: 900; font-variant-numeric: tabular-nums; }
        .col-status { width: 15%; font-weight: 800; font-size: 16px; display: flex; justify-content: center; }

        .next-label {
            border: 4px solid #000;
            padding: 4px 8px;
            display: inline-block;
            line-height: 1;
        }

        /* MAP SECTION */
        #map-section {
            margin-top: 20px;
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }

        #map-canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="route-info">
            <h1>DEPARTURES</h1>
            <p class="route-number">2A</p>
        </div>
        <img src="https://i.imghippo.com/files/AIFK9369Te.png" alt="Bus" class="bus-img" id="bus-toggle" onclick="toggleRoute()">
        <div class="clock-section">
            <div style="font-size: 14px; font-weight: 800;">LOCAL TIME</div>
            <p id="live-clock">00:00:00</p>
        </div>
    </header>

    <div class="board-headers">
        <div style="width: 18%">Time</div>
        <div style="width: 22%">From</div>
        <div style="width: 20%">To</div>
        <div style="width: 25%">Due In</div>
        <div style="width: 15%">Status</div>
    </div>

    <div id="schedule-container"></div>

    <div id="map-section">
        <canvas id="map-canvas"></canvas>
    </div>

    <script>
        let isReturnRoute = false;

        // Departure times from EGHQ 
        const scheduleEGHQ = ["0:15", "0:35", "0:55", "1:15", "1:35", "1:55", "02:25", "02:55", "03:25", "03:55", "04:20", "04:40", "05:00", "5:25", "5:45", "6:05", "6:25", "6:45", "7:10", "7:35", "8:00", "8:25", "8:50", "9:20", "9:45", "10:10", "10:35", "11:00", "11:25", "11:50", "12:10", "12:30", "12:50", "13:10", "13:30", "13:50", "14:15", "14:40", "15:05", "15:30", "15:55", "16:20", "16:45", "17:10", "17:35", "18:00", "18:25", "18:50", "19:15", "19:40", "20:05", "20:30", "20:55", "21:20", "21:45", "22:10", "22:35", "23:00", "23:25", "23:50"];
        
        // Departure times from Grosvenor (third column of document) 
        const scheduleGrosvenor = ["0:43", "1:03", "1:23", "1:43", "2:03", "2:23", "2:53", "3:23", "3:53", "4:23", "4:48", "5:08", "5:28", "5:53", "6:13", "6:33", "6:53", "7:13", "7:38", "8:03", "8:28", "8:53", "9:18", "9:48", "10:13", "10:38", "11:03", "11:28", "11:53", "12:18", "12:38", "12:58", "13:18", "13:38", "13:58", "14:18", "14:43", "15:08", "15:33", "15:58", "16:23", "16:48", "17:17", "17:42", "18:07", "18:32", "18:57", "19:22", "19:47", "20:12", "20:37", "21:00", "21:23", "21:48", "22:13", "22:38", "23:03", "23:28", "23:53"];

        function toggleRoute() {
            isReturnRoute = !isReturnRoute;
            const busImg = document.getElementById('bus-toggle');
            // Instant flip by toggling class without CSS transition
            busImg.className = isReturnRoute ? 'bus-img bus-flipped' : 'bus-img';
            updateBoard();
        }

        function getCorrectedDate() {
            const date = new Date();
            date.setHours(date.getHours() + 4);
            return date;
        }

        function getCountdown(busTimeStr, now) {
            let [h, m] = busTimeStr.split(':').map(Number);
            const busDate = new Date(now);
            busDate.setHours(h, m, 0, 0);

            if (busDate < now) {
                busDate.setDate(busDate.getDate() + 1);
            }

            const diff = busDate - now;
            if (diff <= 0) return "00:00";

            const mins = Math.floor(diff / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            return mins.toString().padStart(2, '0') + ":" + secs.toString().padStart(2, '0');
        }

        function updateBoard() {
            const now = getCorrectedDate();
            document.getElementById('live-clock').innerText = now.toTimeString().split(' ')[0];
            
            const currentStr = now.getHours().toString().padStart(2, '0') + ":" + 
                               now.getMinutes().toString().padStart(2, '0');
            
            // Toggle Departure and Destination based on click 
            const activeSchedule = isReturnRoute ? scheduleEGHQ : scheduleGrosvenor;
            const fromLabel = isReturnRoute ? "EGHQ" : "GROSVENOR";
            const toLabel = isReturnRoute ? "GROSVENOR" : "EGHQ";

            // Normalizing for comparison
            const normalizedSchedule = activeSchedule.map(t => {
                let [h, m] = t.split(':');
                return h.padStart(2, '0') + ":" + m.padStart(2, '0');
            });
            const normalizedCurrent = currentStr;

            let nextIndex = normalizedSchedule.findIndex(t => t > normalizedCurrent);
            if (nextIndex === -1) nextIndex = 0;
            
            let filtered = [];
            for (let i = 0; i < 3; i++) {
                filtered.push(activeSchedule[(nextIndex + i) % activeSchedule.length]);
            }

            document.getElementById('schedule-container').innerHTML = filtered.map((t, i) => `
                <div class="row ${i === 0 ? 'next' : ''}">
                    <div class="col-time">${t}</div>
                    <div class="col-from">${fromLabel}</div>
                    <div class="col-to">${toLabel}</div>
                    <div class="col-due">${getCountdown(t, now)}</div>
                    <div class="col-status">${i === 0 ? '<span class="next-label">NEXT</span>' : 'SCHED'}</div>
                </div>
            `).join('');
        }

        async function fetchCalendar() {
            // Calendar functionality removed - map now displayed
        }

        // ========== MAP CODE ==========
        (function initMap(){
          // --------- E-INK VISIBILITY ----------
          var ROUTE_W_OUT = 14; // white halo
          var ROUTE_W_IN  = 8;  // black core
          var STOP_R_OUT  = 10;
          var STOP_R_IN   = 5;
          var BUS_R_OUT   = 10;
          var BUS_R_IN    = 4;

          // --------- TIMEZONE (Dubai) ----------
          var TZ_OFFSET_MIN = 4 * 60;

          // --------- STOPS ----------
          var STOPS = [
            { lon:55.3659608, lat:25.2417461 }, // EGHQ
            { lon:55.2721115, lat:25.2102779 }, // Pink (back/parking)
            { lon:55.2802068, lat:25.2232332 }, // Grosvenor (back/parking)
            { lon:55.3659608, lat:25.2417461 }  // back EGHQ
          ];

          // --------- EXACT TIMETABLE ROWS (EGHQ, Pink, GROS, EGHQ) ----------
          var TRIPS = [
            ["0:15","0:38","0:43","1:03"],
            ["0:35","0:58","1:03","1:23"],
            ["0:55","1:18","1:23","1:43"],
            ["1:15","1:38","1:43","2:03"],
            ["1:35","1:58","2:03","2:23"],
            ["1:55","2:18","2:23","2:43"],
            ["02:25","2:48","2:53","3:13"],
            ["02:55","3:18","3:23","3:43"],
            ["03:25","3:48","3:53","4:13"],
            ["03:55","4:18","4:23","4:43"],
            ["04:20","4:43","4:48","5:08"],
            ["04:40","5:03","5:08","5:28"],
            ["05:00","5:23","5:28","5:48"],
            ["5:25","5:48","5:53","6:13"],
            ["5:45","6:08","6:13","6:33"],
            ["6:05","6:28","6:33","6:53"],
            ["6:25","6:48","6:53","7:13"],
            ["6:45","7:08","7:13","7:33"],
            ["7:10","7:33","7:38","7:58"],
            ["7:35","7:58","8:03","8:23"],
            ["8:00","8:23","8:28","8:48"],
            ["8:25","8:48","8:53","9:13"],
            ["8:50","9:13","9:18","9:38"],
            ["9:20","9:43","9:48","10:08"],
            ["9:45","10:08","10:13","10:33"],
            ["10:10","10:33","10:38","10:58"],
            ["10:35","10:58","11:03","11:23"],
            ["11:00","11:23","11:28","11:48"],
            ["11:25","11:48","11:53","12:13"],
            ["11:50","12:13","12:18","12:38"],
            ["12:10","12:33","12:38","12:58"],
            ["12:30","12:53","12:58","13:18"],
            ["12:50","13:13","13:18","13:38"],
            ["13:10","13:33","13:38","13:58"],
            ["13:30","13:53","13:58","14:18"],
            ["13:50","14:13","14:18","14:38"],
            ["14:15","14:38","14:43","15:03"],
            ["14:40","15:03","15:08","15:28"],
            ["15:05","15:28","15:33","15:53"],
            ["15:30","15:53","15:58","16:18"],
            ["15:55","16:18","16:23","16:43"],
            ["16:20","16:43","16:48","17:08"],
            ["16:45","17:10","17:17","17:39"],
            ["17:10","17:35","17:42","18:04"],
            ["17:35","18:00","18:07","18:32"],
            ["18:00","18:25","18:32","18:57"],
            ["18:25","18:50","18:57","19:22"],
            ["18:50","19:15","19:22","19:47"],
            ["19:15","19:40","19:47","20:12"],
            ["19:40","20:05","20:12","20:34"],
            ["20:05","20:30","20:37","20:59"],
            ["20:30","20:55","21:00","21:20"],
            ["20:55","21:18","21:23","21:43"],
            ["21:20","21:43","21:48","22:08"],
            ["21:45","22:08","22:13","22:33"],
            ["22:10","22:33","22:38","22:58"],
            ["22:35","22:58","23:03","23:23"],
            ["23:00","23:23","23:28","23:48"],
            ["23:25","23:48","23:53","0:13"],
            ["23:50","0:13","0:18","0:38"]
          ];

          // --------- TILE SOURCE (high contrast, no labels) ----------
          function tileUrl(z,x,y){
            return "https://a.basemaps.cartocdn.com/light_nolabels/" + z + "/" + x + "/" + y + ".png";
          }

          // --------- ROUTE SOURCE ----------
          function osrmUrl(){
            var s = "";
            for (var i=0;i<STOPS.length;i++){
              if (i) s += ";";
              s += STOPS[i].lon + "," + STOPS[i].lat;
            }
            return "https://router.project-osrm.org/route/v1/driving/" + s + "?overview=full&geometries=geojson&steps=false";
          }

          // --------- CANVAS ----------
          var canvas = document.getElementById("map-canvas");
          var ctx = canvas.getContext("2d", {alpha:false});
          var CANVAS_CSS_W = 0;
          var CANVAS_CSS_H = 0;

          function getCanvasCssSize(){
            var container = document.getElementById('map-section');
            var w = container.offsetWidth || container.clientWidth || window.innerWidth - 40;
            var h = container.offsetHeight || container.clientHeight || (window.innerHeight / 2);
            return { w: w, h: h };
          }

          function resize(){
            var size = getCanvasCssSize();
            var w = size.w;
            var h = size.h;
            var dpr = window.devicePixelRatio || 1;
            CANVAS_CSS_W = w;
            CANVAS_CSS_H = h;
            canvas.style.width = w + "px";
            canvas.style.height = h + "px";
            canvas.width = Math.max(1, Math.floor(w * dpr));
            canvas.height = Math.max(1, Math.floor(h * dpr));
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            ctx.imageSmoothingEnabled = true;
            if (routeLL && cum && C) {
              setTimeout(draw, 50);
            }
          }
          
          setTimeout(resize, 100);
          window.addEventListener("resize", function(){
            resize();
          }, false);

          // --------- HELPERS ----------
          var TILE = 256;

          function ll2px(lon, lat, z){
            var scale = TILE * Math.pow(2, z);
            var x = (lon + 180) / 360 * scale;
            var sin = Math.sin(lat * Math.PI / 180);
            var y = (0.5 - Math.log((1 + sin) / (1 - sin)) / (4 * Math.PI)) * scale;
            return { x:x, y:y };
          }

          function haversineMeters(a,b){
            var R=6371000;
            function toRad(d){ return d*Math.PI/180; }
            var dLat = toRad(b.lat-a.lat);
            var dLon = toRad(b.lon-a.lon);
            var s1 = Math.sin(dLat/2), s2 = Math.sin(dLon/2);
            var q = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
            return 2*R*Math.asin(Math.min(1, Math.sqrt(q)));
          }

          function parseHHMM(s){
            var parts = s.split(":");
            return parseInt(parts[0],10)*60 + parseInt(parts[1],10);
          }

          function normalizeTrip(row){
            var t = [parseHHMM(row[0]), parseHHMM(row[1]), parseHHMM(row[2]), parseHHMM(row[3])];
            for (var i=1;i<4;i++){
              while (t[i] < t[i-1]) t[i] += 1440;
            }
            return t;
          }

          var TRIP_ABS = [];
          for (var i=0;i<TRIPS.length;i++) TRIP_ABS.push(normalizeTrip(TRIPS[i]));

          function nowLocalMinutesFloat(){
            var d = new Date();
            var utc = d.getUTCHours()*60 + d.getUTCMinutes() + d.getUTCSeconds()/60;
            var m = utc + TZ_OFFSET_MIN;
            m = ((m % 1440) + 1440) % 1440;
            return m;
          }

          function activeBuses(nowMin){
            var buses = [];
            for (var i=0;i<TRIP_ABS.length;i++){
              var t = TRIP_ABS[i];
              for (var si=0; si<2; si++){
                var shift = (si===0) ? 0 : -1440;
                var t0=t[0]+shift, t1=t[1]+shift, t2=t[2]+shift, t3=t[3]+shift;

                var nowA = nowMin;
                var nowB = nowMin - 1440;

                if ((nowA>=t0 && nowA<t3) || (nowB>=t0 && nowB<t3)){
                  var useNow = (nowA>=t0 && nowA<t3) ? nowA : nowB;
                  buses.push({ i:i, now:useNow, t0:t0, t1:t1, t2:t2, t3:t3 });
                  break;
                }
              }
            }
            return buses;
          }

          // --------- GLOBAL DRAW STATE ----------
          var routeLL = null;
          var cum = null;
          var Z = 12;
          var C = null;

          // --------- TILE CACHE ----------
          var tileCache = {};
          function getTile(z,x,y){
            var k = z + "/" + x + "/" + y;
            if (tileCache[k]) return tileCache[k];
            var img = new Image();
            img.src = tileUrl(z,x,y);
            tileCache[k] = img;
            return img;
          }

          // --------- OSRM LOAD (XHR, kindle-friendly) ----------
          function xhrJson(url, cb){
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function(){
              if (xhr.readyState === 4){
                try { cb(JSON.parse(xhr.responseText)); } catch(e){ cb(null); }
              }
            };
            xhr.send(null);
          }

          function buildRouteAndStart(){
            xhrJson(osrmUrl(), function(j){
              if (!j || !j.routes || !j.routes[0] || !j.routes[0].geometry) return;
              var coords = j.routes[0].geometry.coordinates;

              routeLL = [];
              for (var i=0;i<coords.length;i++){
                routeLL.push({ lon: coords[i][0], lat: coords[i][1] });
              }

              // bounds & zoom
              var minLon=1e9,maxLon=-1e9,minLat=1e9,maxLat=-1e9;
              for (var k=0;k<routeLL.length;k++){
                var p=routeLL[k];
                if (p.lon<minLon) minLon=p.lon;
                if (p.lon>maxLon) maxLon=p.lon;
                if (p.lat<minLat) minLat=p.lat;
                if (p.lat>maxLat) maxLat=p.lat;
              }
              
              var size = getCanvasCssSize();
              var w = size.w;
              var h = size.h;
              
              for (var z=18; z>=11; z--){
                var a = ll2px(minLon, maxLat, z);
                var b = ll2px(maxLon, minLat, z);
                var routeW = Math.abs(b.x-a.x);
                var routeH = Math.abs(b.y-a.y);
                if (routeW < w-40 && routeH < h-40){
                  Z = z; break;
                }
              }
              C = ll2px((minLon+maxLon)/2, (minLat+maxLat)/2, Z);

              // cumulative distance
              cum = [0];
              for (var i2=1;i2<routeLL.length;i2++){
                cum[i2] = cum[i2-1] + haversineMeters(routeLL[i2-1], routeLL[i2]);
              }

              // Ensure canvas is properly sized before drawing
              resize();
              
              // Start redraw loop (1s)
              setInterval(draw, 1000);
              draw();
            });
          }

          function pointAtDistance(d){
            var total = cum[cum.length-1];
            if (d<0) d=0;
            if (d>total) d=total;

            var lo=1, hi=cum.length-1;
            while (lo<hi){
              var mid = (lo+hi)>>1;
              if (cum[mid] < d) lo = mid+1; else hi = mid;
            }
            var i = lo;
            var d0=cum[i-1], d1=cum[i];
            var t = (d1===d0) ? 0 : (d-d0)/(d1-d0);
            var a=routeLL[i-1], b=routeLL[i];
            return { lon: a.lon + (b.lon-a.lon)*t, lat: a.lat + (b.lat-a.lat)*t };
          }

          function busDistanceExact(bus){
            var now = bus.now, t0=bus.t0, t1=bus.t1, t2=bus.t2, t3=bus.t3;
            var total = cum[cum.length-1];

            var dt = (t3 - t0) || 1;
            var f1 = (t1 - t0) / dt;
            var f2 = (t2 - t0) / dt;

            var d0 = 0;
            var d1 = total * f1;
            var d2 = total * f2;
            var d3 = total;

            if (now <= t0) return d0;
            if (now <  t1){
              return d0 + (d1-d0) * ((now-t0)/((t1-t0)||1));
            }
            if (now <  t2){
              return d1 + (d2-d1) * ((now-t1)/((t2-t1)||1));
            }
            if (now <  t3){
              return d2 + (d3-d2) * ((now-t2)/((t3-t2)||1));
            }
            return d3;
          }

          function draw(){
            if (!routeLL || !cum || !C) return;

            var w = CANVAS_CSS_W || canvas.clientWidth || canvas.width;
            var h = CANVAS_CSS_H || canvas.clientHeight || canvas.height;
            ctx.fillStyle="#fff";
            ctx.fillRect(0,0,w,h);

            var TL = { x: C.x - w/2, y: C.y - h/2 };
            var maxT = Math.pow(2, Z) - 1;

            // tiles
            for (var ty=Math.floor(TL.y/TILE); ty<=Math.floor((TL.y+h)/TILE); ty++){
              if (ty<0 || ty>maxT) continue;
              for (var tx=Math.floor(TL.x/TILE); tx<=Math.floor((TL.x+w)/TILE); tx++){
                var x = tx % (maxT+1); if (x<0) x += (maxT+1);
                var img = getTile(Z, x, ty);
                if (img.complete){
                  ctx.drawImage(img, tx*TILE - TL.x, ty*TILE - TL.y, TILE, TILE);
                }
              }
            }

            // route halo
            ctx.lineJoin="round"; ctx.lineCap="round";
            ctx.strokeStyle="#fff"; ctx.lineWidth=ROUTE_W_OUT;
            ctx.beginPath();
            for (var i=0;i<routeLL.length;i++){
              var p = ll2px(routeLL[i].lon, routeLL[i].lat, Z);
              var x2 = p.x - TL.x, y2 = p.y - TL.y;
              if (!i) ctx.moveTo(x2,y2); else ctx.lineTo(x2,y2);
            }
            ctx.stroke();

            // route core
            ctx.strokeStyle="#000"; ctx.lineWidth=ROUTE_W_IN;
            ctx.stroke();

            // stop markers (3 unique)
            for (var si=0; si<3; si++){
              var sp = ll2px(STOPS[si].lon, STOPS[si].lat, Z);
              var sx = sp.x - TL.x, sy = sp.y - TL.y;

              ctx.fillStyle="#fff"; ctx.strokeStyle="#000"; ctx.lineWidth=4;
              ctx.beginPath();
              ctx.rect(sx - STOP_R_OUT, sy - STOP_R_OUT, STOP_R_OUT * 2, STOP_R_OUT * 2);
              ctx.fill(); ctx.stroke();

              ctx.fillStyle="#000";
              ctx.beginPath();
              ctx.rect(sx - STOP_R_IN, sy - STOP_R_IN, STOP_R_IN * 2, STOP_R_IN * 2);
              ctx.fill();
            }

            // buses
            var now = nowLocalMinutesFloat();
            var buses = activeBuses(now);

            // Draw all buses active now
            for (var bi=0; bi<buses.length; bi++){
              var b = buses[bi];
              var dist = busDistanceExact(b);
              var pos = pointAtDistance(dist);
              var bp = ll2px(pos.lon, pos.lat, Z);

              var bx = bp.x - TL.x;
              var by = bp.y - TL.y;

              // tiny offset per bus to reduce overlap
              var ang = (b.i * 137.5) * Math.PI / 180;
              bx += Math.cos(ang) * 2.5;
              by += Math.sin(ang) * 2.5;

              ctx.fillStyle="#fff";
              ctx.beginPath(); ctx.arc(bx,by,BUS_R_OUT,0,Math.PI*2); ctx.fill();

              ctx.fillStyle="#000";
              ctx.beginPath(); ctx.arc(bx,by,BUS_R_OUT-2,0,Math.PI*2); ctx.fill();

              ctx.fillStyle="#fff";
              ctx.beginPath(); ctx.arc(bx,by,BUS_R_IN,0,Math.PI*2); ctx.fill();
            }
          }

          buildRouteAndStart();
        })();

        setInterval(updateBoard, 1000);
        updateBoard();
    </script>
</body>
</html>
